{"version":3,"file":"ws-provider.mjs","sources":["../../../src/ws-provider.ts"],"sourcesContent":["import { getSyncProvider } from \"@polkadot-api/json-rpc-provider-proxy\"\nimport {\n  GetWsProviderInput,\n  StatusChange,\n  WsJsonRpcProvider,\n  WsEvent,\n  WsProviderConfig,\n} from \"./types\"\nimport { followEnhancer } from \"./follow-enhancer\"\n\nconst timeoutError: StatusChange = {\n  type: WsEvent.ERROR,\n  event: { type: \"timeout\" },\n}\n\nconst noop = () => {}\n\nconst mapEndpoints = (\n  endpoints: WsProviderConfig[\"endpoints\"],\n): Array<[string, string | string[]] | [string]> =>\n  endpoints.map((x) => (typeof x === \"string\" ? [x] : [x.uri, x.protocol]))\n\nexport const getInternalWsProvider = (\n  WebsocketClass: typeof WebSocket,\n): GetWsProviderInput => {\n  return (...args): WsJsonRpcProvider => {\n    let endpoints: Array<[string, string | string[]] | [string]> = []\n    let onStatusChanged: (status: StatusChange) => void = noop\n    let timeout = 3_500\n\n    const [firstArg] = args\n    if (\n      args.length === 1 &&\n      typeof firstArg === \"object\" &&\n      !Array.isArray(firstArg)\n    ) {\n      endpoints = mapEndpoints(firstArg.endpoints)\n      onStatusChanged = firstArg.onStatusChanged ?? noop\n      timeout = firstArg.timeout ?? timeout\n    } else {\n      if (typeof args[1] === \"function\")\n        onStatusChanged = args[1] as (status: StatusChange) => void\n      if (Array.isArray(firstArg)) endpoints = mapEndpoints(firstArg)\n      else {\n        endpoints = [[firstArg as string]]\n        if (args[1] && args[1] !== onStatusChanged)\n          endpoints[0][1] = args[1] as any\n        if (args[2]) onStatusChanged = args[2] as any\n      }\n    }\n\n    let idx = 0\n    let status: StatusChange\n    let switchTo: [string] | [string, string | string[]] | null = null\n    let disconnect: (withHalt?: boolean) => void = noop\n\n    let outerCleanup: () => void = noop\n    const result = followEnhancer(\n      getSyncProvider(async () => {\n        const [uri, protocols] = switchTo || endpoints[idx++ % endpoints.length]\n        switchTo = null\n        const socket = new WebsocketClass(uri, protocols)\n        const forceSocketClose = () => {\n          try {\n            socket.addEventListener(\"error\", noop, { once: true })\n            socket.close()\n          } catch {}\n        }\n        onStatusChanged(\n          (status = {\n            type: WsEvent.CONNECTING,\n            uri,\n            protocols,\n          }),\n        )\n\n        await new Promise<void>((resolve, reject) => {\n          const onOpen = () => {\n            initialCleanup()\n            resolve()\n          }\n\n          const onError = (e: Event | null) => {\n            initialCleanup()\n            if (e == null) forceSocketClose()\n            console.error(\n              `Unable to connect to ${uri}${\n                protocols ? \", protocols: \" + protocols : \"\"\n              }`,\n            )\n            onStatusChanged(\n              (status = {\n                type: e ? WsEvent.ERROR : WsEvent.CLOSE,\n                event: e,\n              }),\n            )\n            setTimeout(reject, e ? 300 : 0, e)\n          }\n\n          const timeoutToken =\n            timeout !== Infinity\n              ? setTimeout(() => {\n                  initialCleanup()\n                  forceSocketClose()\n                  onStatusChanged((status = timeoutError))\n                  reject(timeoutError.event)\n                }, timeout)\n              : undefined\n\n          const initialCleanup = () => {\n            clearTimeout(timeoutToken)\n            socket.removeEventListener(\"error\", onError)\n            socket.removeEventListener(\"open\", onOpen)\n          }\n          socket.addEventListener(\"open\", onOpen)\n          socket.addEventListener(\"error\", onError)\n          disconnect = () => {\n            onError(null)\n          }\n        })\n\n        onStatusChanged(\n          (status = {\n            type: WsEvent.CONNECTED,\n            uri,\n            protocols,\n          }),\n        )\n\n        return (onMessage, onHalt) => {\n          const _onMessage = (e: MessageEvent) => {\n            if (typeof e.data === \"string\") onMessage(e.data)\n          }\n          const innerHalt =\n            (reason: WsEvent.CLOSE | WsEvent.ERROR) => (e: any) => {\n              console.warn(`WS halt (${reason})`)\n              onStatusChanged(\n                (status = {\n                  type: reason,\n                  event: e,\n                }),\n              )\n              onHalt()\n            }\n          const onError = innerHalt(WsEvent.ERROR)\n          const onClose = innerHalt(WsEvent.CLOSE)\n\n          socket.addEventListener(\"message\", _onMessage)\n          socket.addEventListener(\"error\", onError)\n          socket.addEventListener(\"close\", onClose)\n          disconnect = (withHalt) => {\n            outerCleanup()\n            disconnect = noop\n            socket.removeEventListener(\"message\", _onMessage)\n            socket.removeEventListener(\"error\", onError)\n            socket.removeEventListener(\"close\", onClose)\n            forceSocketClose()\n            if (withHalt) onClose({})\n          }\n\n          return {\n            send: (msg) => {\n              socket.send(msg)\n            },\n            disconnect,\n          }\n        }\n      }),\n      () => {\n        switchFn()\n      },\n    )\n    outerCleanup = result.cleanup\n    delete (result as any).cleanup\n\n    const switchFn: WsJsonRpcProvider[\"switch\"] = (...args) => {\n      if (status.type === WsEvent.CLOSE) return\n      if (args.length) switchTo = args as any\n      if (status.type !== WsEvent.ERROR) disconnect(true)\n    }\n\n    return Object.assign(result, { switch: switchFn, getStatus: () => status })\n  }\n}\n"],"names":["args"],"mappings":"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"}