{"version":3,"file":"getObservableClient.mjs","sources":["../../src/getObservableClient.ts"],"sourcesContent":["import {\n  type SubstrateClient,\n  type UnsubscribeFn,\n} from \"@polkadot-api/substrate-client\"\nimport { noop, Observable, of } from \"rxjs\"\nimport { ChainHead$, getChainHead$, RuntimeContext } from \"./chainHead\"\nimport getBroadcastTx$ from \"./tx\"\nimport { Archive$, getArchive } from \"./archive\"\n\nconst ofNullFn = () => of(null)\n\nexport interface ObservableClient {\n  chainHead$: (nSubscribers?: number) => ChainHead$\n  archive: (\n    getRuntime: (codeHash: string) => Observable<RuntimeContext | null>,\n  ) => Archive$\n  broadcastTx$: (transaction: string) => Observable<never>\n  destroy: UnsubscribeFn\n}\n\nconst clientCache = new Map<\n  SubstrateClient,\n  { client: ObservableClient; refCount: number }\n>()\n\nexport const getObservableClient = (\n  substrateClient: SubstrateClient,\n  cache: Partial<{\n    getMetadata: (codeHash: string) => Observable<Uint8Array | null>\n    setMetadata: (codeHash: string, rawMetadata: Uint8Array) => void\n  }> = {},\n): ObservableClient => {\n  const { getMetadata, setMetadata } = cache\n  const cached = clientCache.get(substrateClient)\n  if (cached) {\n    cached.refCount++\n    return cached.client\n  }\n\n  const destroy = () => {\n    const cached = clientCache.get(substrateClient)\n    if (!cached || cached.refCount <= 1) {\n      clientCache.delete(substrateClient)\n      substrateClient.destroy()\n    } else {\n      cached.refCount--\n    }\n  }\n\n  let cachedChainhead:\n    | readonly [ChainHead$, (nSubscribers: number) => void]\n    | null = null\n  let currentSubscribers = 0\n  let expectedSubscribers: null | number = null\n\n  const client: ObservableClient = {\n    chainHead$: (_expectedSubscribers) => {\n      currentSubscribers++\n      expectedSubscribers ||= _expectedSubscribers || 1\n      cachedChainhead ||= getChainHead$(\n        substrateClient.chainHead,\n        getMetadata || ofNullFn,\n        setMetadata || noop,\n      )\n      const [result, start] = cachedChainhead\n      if (expectedSubscribers === currentSubscribers) {\n        const copiedCurrentSubscribers = currentSubscribers\n        currentSubscribers = 0\n        expectedSubscribers = null\n        cachedChainhead = null\n        start(copiedCurrentSubscribers)\n      }\n      return result\n    },\n    archive: getArchive(substrateClient.archive),\n    broadcastTx$: getBroadcastTx$(substrateClient.transaction),\n    destroy,\n  }\n\n  clientCache.set(substrateClient, { client, refCount: 1 })\n  return client\n}\n"],"names":["cached"],"mappings":";;;;;AASA,MAAM,QAAA,GAAW,MAAM,EAAA,CAAG,IAAI,CAAA;AAW9B,MAAM,WAAA,uBAAkB,GAAA,EAGtB;AAEK,MAAM,mBAAA,GAAsB,CACjC,eAAA,EACA,KAAA,GAGK,EAAC,KACe;AACrB,EAAA,MAAM,EAAE,WAAA,EAAa,WAAA,EAAY,GAAI,KAAA;AACrC,EAAA,MAAM,MAAA,GAAS,WAAA,CAAY,GAAA,CAAI,eAAe,CAAA;AAC9C,EAAA,IAAI,MAAA,EAAQ;AACV,IAAA,MAAA,CAAO,QAAA,EAAA;AACP,IAAA,OAAO,MAAA,CAAO,MAAA;AAAA,EAChB;AAEA,EAAA,MAAM,UAAU,MAAM;AACpB,IAAA,MAAMA,OAAAA,GAAS,WAAA,CAAY,GAAA,CAAI,eAAe,CAAA;AAC9C,IAAA,IAAI,CAACA,OAAAA,IAAUA,OAAAA,CAAO,QAAA,IAAY,CAAA,EAAG;AACnC,MAAA,WAAA,CAAY,OAAO,eAAe,CAAA;AAClC,MAAA,eAAA,CAAgB,OAAA,EAAQ;AAAA,IAC1B,CAAA,MAAO;AACL,MAAAA,OAAAA,CAAO,QAAA,EAAA;AAAA,IACT;AAAA,EACF,CAAA;AAEA,EAAA,IAAI,eAAA,GAEO,IAAA;AACX,EAAA,IAAI,kBAAA,GAAqB,CAAA;AACzB,EAAA,IAAI,mBAAA,GAAqC,IAAA;AAEzC,EAAA,MAAM,MAAA,GAA2B;AAAA,IAC/B,UAAA,EAAY,CAAC,oBAAA,KAAyB;AACpC,MAAA,kBAAA,EAAA;AACA,MAAA,mBAAA,KAAA,mBAAA,GAAwB,oBAAA,IAAwB,CAAA,CAAA;AAChD,MAAA,eAAA,KAAA,eAAA,GAAoB,aAAA;AAAA,QAClB,eAAA,CAAgB,SAAA;AAAA,QAChB,WAAA,IAAe,QAAA;AAAA,QACf,WAAA,IAAe;AAAA,OACjB,CAAA;AACA,MAAA,MAAM,CAAC,MAAA,EAAQ,KAAK,CAAA,GAAI,eAAA;AACxB,MAAA,IAAI,wBAAwB,kBAAA,EAAoB;AAC9C,QAAA,MAAM,wBAAA,GAA2B,kBAAA;AACjC,QAAA,kBAAA,GAAqB,CAAA;AACrB,QAAA,mBAAA,GAAsB,IAAA;AACtB,QAAA,eAAA,GAAkB,IAAA;AAClB,QAAA,KAAA,CAAM,wBAAwB,CAAA;AAAA,MAChC;AACA,MAAA,OAAO,MAAA;AAAA,IACT,CAAA;AAAA,IACA,OAAA,EAAS,UAAA,CAAW,eAAA,CAAgB,OAAO,CAAA;AAAA,IAC3C,YAAA,EAAc,eAAA,CAAgB,eAAA,CAAgB,WAAW,CAAA;AAAA,IACzD;AAAA,GACF;AAEA,EAAA,WAAA,CAAY,IAAI,eAAA,EAAiB,EAAE,MAAA,EAAQ,QAAA,EAAU,GAAG,CAAA;AACxD,EAAA,OAAO,MAAA;AACT;;;;"}