{"version":3,"file":"new-blocks.mjs","sources":["../../../src/chainHead/new-blocks.ts"],"sourcesContent":["import { mergeMap, Observable, scan, share } from \"rxjs\"\nimport { BlockInfo } from \"./chainHead\"\nimport { PinnedBlocks } from \"./streams\"\n\nexport const getNewBlocks$ = (pinnedBlocks$: Observable<PinnedBlocks>) =>\n  pinnedBlocks$.pipe(\n    scan(\n      ({ reportedBlocks: prevReportedBlocks }, { blocks }) => {\n        const reportedBlocks = new Set<string>(blocks.keys())\n        const newBlocks: BlockInfo[] = []\n\n        if (reportedBlocks.size > prevReportedBlocks.size) {\n          blocks.forEach(({ hash, number, parent }) => {\n            if (!prevReportedBlocks.has(hash)) {\n              newBlocks.push({\n                hash,\n                number,\n                parent,\n              })\n            }\n          })\n        }\n\n        return { reportedBlocks, newBlocks }\n      },\n      {\n        reportedBlocks: new Set<string>(),\n        newBlocks: new Array<BlockInfo>(0),\n      },\n    ),\n    mergeMap(({ newBlocks }) => newBlocks),\n    share(),\n  )\n"],"names":[],"mappings":";;AAIO,MAAM,aAAA,GAAgB,CAAC,aAAA,KAC5B,aAAA,CAAc,IAAA;AAAA,EACZ,IAAA;AAAA,IACE,CAAC,EAAE,cAAA,EAAgB,oBAAmB,EAAG,EAAE,QAAO,KAAM;AACtD,MAAA,MAAM,cAAA,GAAiB,IAAI,GAAA,CAAY,MAAA,CAAO,MAAM,CAAA;AACpD,MAAA,MAAM,YAAyB,EAAC;AAEhC,MAAA,IAAI,cAAA,CAAe,IAAA,GAAO,kBAAA,CAAmB,IAAA,EAAM;AACjD,QAAA,MAAA,CAAO,QAAQ,CAAC,EAAE,IAAA,EAAM,MAAA,EAAQ,QAAO,KAAM;AAC3C,UAAA,IAAI,CAAC,kBAAA,CAAmB,GAAA,CAAI,IAAI,CAAA,EAAG;AACjC,YAAA,SAAA,CAAU,IAAA,CAAK;AAAA,cACb,IAAA;AAAA,cACA,MAAA;AAAA,cACA;AAAA,aACD,CAAA;AAAA,UACH;AAAA,QACF,CAAC,CAAA;AAAA,MACH;AAEA,MAAA,OAAO,EAAE,gBAAgB,SAAA,EAAU;AAAA,IACrC,CAAA;AAAA,IACA;AAAA,MACE,cAAA,sBAAoB,GAAA,EAAY;AAAA,MAChC,SAAA,EAAW,IAAI,KAAA,CAAiB,CAAC;AAAA;AACnC,GACF;AAAA,EACA,QAAA,CAAS,CAAC,EAAE,SAAA,OAAgB,SAAS,CAAA;AAAA,EACrC,KAAA;AACF;;;;"}