{"version":3,"file":"optionalHash.mjs","sources":["../../../../src/chainHead/enhancers/optionalHash.ts"],"sourcesContent":["import {\n  MonoTypeOperatorFunction,\n  Observable,\n  catchError,\n  concatMap,\n  mergeMap,\n  take,\n  throwError,\n  timer,\n} from \"rxjs\"\nimport { BlockNotPinnedError } from \"../errors\"\nimport { OperationInaccessibleError } from \"@polkadot-api/substrate-client\"\n\nconst dynamicBlocks = new Set([\"best\", \"finalized\", null])\n\nconst operable = <T>(source$: Observable<T>) => {\n  const result: Observable<T> = source$.pipe(\n    catchError((e) =>\n      e instanceof OperationInaccessibleError\n        ? timer(750).pipe(concatMap(() => result))\n        : throwError(() => e),\n    ),\n  )\n  return result\n}\n\nexport const getWithOptionalHash$ = (\n  finalized$: Observable<string>,\n  best$: Observable<string>,\n  usingBlock: <T>(blockHash: string) => MonoTypeOperatorFunction<T>,\n) => {\n  return <Args extends Array<any>, T>(\n      fn: (hash: string, ...args: Args) => Observable<T>,\n    ) =>\n    (hash: string | null, ...args: Args) => {\n      if (!dynamicBlocks.has(hash))\n        return operable(fn(hash as string, ...args)).pipe(\n          usingBlock(hash as string),\n        )\n\n      const hash$ = hash === \"best\" ? best$ : finalized$\n      const result$: Observable<T> = hash$.pipe(\n        take(1),\n        mergeMap((h) => fn(h, ...args).pipe(usingBlock(h))),\n        catchError((e) => {\n          return e instanceof BlockNotPinnedError\n            ? result$\n            : throwError(() => e)\n        }),\n      )\n      return operable(result$)\n    }\n}\n"],"names":[],"mappings":";;;;AAaA,MAAM,gCAAgB,IAAI,GAAA,CAAI,CAAC,MAAA,EAAQ,WAAA,EAAa,IAAI,CAAC,CAAA;AAEzD,MAAM,QAAA,GAAW,CAAI,OAAA,KAA2B;AAC9C,EAAA,MAAM,SAAwB,OAAA,CAAQ,IAAA;AAAA,IACpC,UAAA;AAAA,MAAW,CAAC,CAAA,KACV,CAAA,YAAa,0BAAA,GACT,MAAM,GAAG,CAAA,CAAE,IAAA,CAAK,SAAA,CAAU,MAAM,MAAM,CAAC,CAAA,GACvC,UAAA,CAAW,MAAM,CAAC;AAAA;AACxB,GACF;AACA,EAAA,OAAO,MAAA;AACT,CAAA;AAEO,MAAM,oBAAA,GAAuB,CAClC,UAAA,EACA,KAAA,EACA,UAAA,KACG;AACH,EAAA,OAAO,CACH,EAAA,KAEF,CAAC,IAAA,EAAA,GAAwB,IAAA,KAAe;AACtC,IAAA,IAAI,CAAC,aAAA,CAAc,GAAA,CAAI,IAAI,CAAA;AACzB,MAAA,OAAO,SAAS,EAAA,CAAG,IAAA,EAAgB,GAAG,IAAI,CAAC,CAAA,CAAE,IAAA;AAAA,QAC3C,WAAW,IAAc;AAAA,OAC3B;AAEF,IAAA,MAAM,KAAA,GAAQ,IAAA,KAAS,MAAA,GAAS,KAAA,GAAQ,UAAA;AACxC,IAAA,MAAM,UAAyB,KAAA,CAAM,IAAA;AAAA,MACnC,KAAK,CAAC,CAAA;AAAA,MACN,QAAA,CAAS,CAAC,CAAA,KAAM,EAAA,CAAG,CAAA,EAAG,GAAG,IAAI,CAAA,CAAE,IAAA,CAAK,UAAA,CAAW,CAAC,CAAC,CAAC,CAAA;AAAA,MAClD,UAAA,CAAW,CAAC,CAAA,KAAM;AAChB,QAAA,OAAO,CAAA,YAAa,mBAAA,GAChB,OAAA,GACA,UAAA,CAAW,MAAM,CAAC,CAAA;AAAA,MACxB,CAAC;AAAA,KACH;AACA,IAAA,OAAO,SAAS,OAAO,CAAA;AAAA,EACzB,CAAA;AACJ;;;;"}