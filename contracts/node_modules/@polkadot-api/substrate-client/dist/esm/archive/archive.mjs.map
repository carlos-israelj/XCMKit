{"version":3,"file":"archive.mjs","sources":["../../../src/archive/archive.ts"],"sourcesContent":["import { abortablePromiseFn } from \"@/internal-utils\"\nimport { type ClientRequest } from \"../client\"\nimport { createStorageCb } from \"./storage-subscription\"\nimport { createStorageFn } from \"./storage\"\nimport { Archive } from \"./public-types\"\nimport { CallError, BlockHashNotFoundError } from \"./errors\"\n\nconst identity =\n  <T>() =>\n  (x: T): T =>\n    x\n\nconst handleInvalidBlockHash =\n  <T>() =>\n  (result: T | null, hash: string): T => {\n    if (result === null) throw new BlockHashNotFoundError(hash)\n    return result\n  }\n\nexport const getArchive = (request: ClientRequest<any, any>): Archive => {\n  const archiveRequest: ClientRequest<any, any> = (method: string, ...rest) =>\n    request(`archive_v1_${method}`, ...rest)\n\n  const fnCreator =\n    <A extends Array<any>>(method: string) =>\n    <I, O>(mapper: (input: I, ...args: A) => O) =>\n      abortablePromiseFn<O, A>((res, rej, ...args) =>\n        archiveRequest(method, args, {\n          onSuccess: (x: I) => {\n            try {\n              res(mapper(x, ...args))\n            } catch (e) {\n              rej(e)\n            }\n          },\n          onError: rej,\n        }),\n      )\n\n  const header = fnCreator<[hash: string]>(\"header\")(\n    handleInvalidBlockHash<string>(),\n  )\n\n  const body = fnCreator<[hash: string]>(\"body\")(\n    handleInvalidBlockHash<string[]>(),\n  )\n\n  const storageSubscription = createStorageCb(archiveRequest)\n  const storage = createStorageFn(storageSubscription)\n\n  const call = fnCreator<\n    [hash: string, function: string, callParameters: string]\n  >(\"call\")((\n    x:\n      | { success: true; value: string }\n      | { success: false; error: string }\n      | null,\n    hash,\n  ) => {\n    if (!x) throw new BlockHashNotFoundError(hash)\n    if (!x.success) throw new CallError(x.error)\n    return x.value\n  })\n\n  const finalizedHeight = fnCreator<[]>(\"finalizedHeight\")(identity<number>())\n  const hashByHeight =\n    fnCreator<[height: number]>(\"hashByHeight\")(identity<string[]>())\n\n  return {\n    header,\n    body,\n    storageSubscription,\n    storage,\n    call,\n    finalizedHeight,\n    hashByHeight,\n  }\n}\n"],"names":[],"mappings":";;;;;AAOA,MAAM,QAAA,GACJ,MACA,CAAC,CACC,KAAA,CAAA;AAEJ,MAAM,sBACJ,GAAA,MACA,CAAC,MAAA,EAAkB,IAAoB,KAAA;AACrC,EAAA,IAAI,MAAW,KAAA,IAAA,EAAY,MAAA,IAAI,uBAAuB,IAAI,CAAA;AAC1D,EAAO,OAAA,MAAA;AACT,CAAA;AAEW,MAAA,UAAA,GAAa,CAAC,OAA8C,KAAA;AACvE,EAAM,MAAA,cAAA,GAA0C,CAAC,MAAmB,EAAA,GAAA,IAAA,KAClE,QAAQ,CAAc,WAAA,EAAA,MAAM,CAAI,CAAA,EAAA,GAAG,IAAI,CAAA;AAEzC,EAAA,MAAM,SACJ,GAAA,CAAuB,MACvB,KAAA,CAAO,MACL,KAAA,kBAAA;AAAA,IAAyB,CAAC,GAAK,EAAA,GAAA,EAAA,GAAQ,IACrC,KAAA,cAAA,CAAe,QAAQ,IAAM,EAAA;AAAA,MAC3B,SAAA,EAAW,CAAC,CAAS,KAAA;AACnB,QAAI,IAAA;AACF,UAAA,GAAA,CAAI,MAAO,CAAA,CAAA,EAAG,GAAG,IAAI,CAAC,CAAA;AAAA,iBACf,CAAG,EAAA;AACV,UAAA,GAAA,CAAI,CAAC,CAAA;AAAA;AACP,OACF;AAAA,MACA,OAAS,EAAA;AAAA,KACV;AAAA,GACH;AAEJ,EAAM,MAAA,MAAA,GAAS,UAA0B,QAAQ,CAAA;AAAA,IAC/C,sBAA+B;AAAA,GACjC;AAEA,EAAM,MAAA,IAAA,GAAO,UAA0B,MAAM,CAAA;AAAA,IAC3C,sBAAiC;AAAA,GACnC;AAEA,EAAM,MAAA,mBAAA,GAAsB,gBAAgB,cAAc,CAAA;AAC1D,EAAM,MAAA,OAAA,GAAU,gBAAgB,mBAAmB,CAAA;AAEnD,EAAA,MAAM,OAAO,SAEX,CAAA,MAAM,CAAE,CAAA,CACR,GAIA,IACG,KAAA;AACH,IAAA,IAAI,CAAC,CAAA,EAAS,MAAA,IAAI,uBAAuB,IAAI,CAAA;AAC7C,IAAA,IAAI,CAAC,CAAE,CAAA,OAAA,QAAe,IAAI,SAAA,CAAU,EAAE,KAAK,CAAA;AAC3C,IAAA,OAAO,CAAE,CAAA,KAAA;AAAA,GACV,CAAA;AAED,EAAA,MAAM,eAAkB,GAAA,SAAA,CAAc,iBAAiB,CAAA,CAAE,UAAkB,CAAA;AAC3E,EAAA,MAAM,YACJ,GAAA,SAAA,CAA4B,cAAc,CAAA,CAAE,UAAoB,CAAA;AAElE,EAAO,OAAA;AAAA,IACL,MAAA;AAAA,IACA,IAAA;AAAA,IACA,mBAAA;AAAA,IACA,OAAA;AAAA,IACA,IAAA;AAAA,IACA,eAAA;AAAA,IACA;AAAA,GACF;AACF;;;;"}