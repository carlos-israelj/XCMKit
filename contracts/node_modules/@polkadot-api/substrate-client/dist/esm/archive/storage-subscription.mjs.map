{"version":3,"file":"storage-subscription.mjs","sources":["../../../src/archive/storage-subscription.ts"],"sourcesContent":["import type { ClientRequest } from \"@/client\"\nimport { noop } from \"@polkadot-api/utils\"\nimport { Archive } from \"./public-types\"\nimport { StorageItemResponse } from \"@/chainhead\"\nimport { StorageError } from \"./errors\"\n\ntype StorageEvent = {\n  event: \"storage\"\n} & StorageItemResponse\n\ntype StorageDone = {\n  event: \"storageDone\"\n}\n\ntype StorageErrorEvent = {\n  event: \"storageError\"\n  error: string\n}\n\nexport const createStorageCb =\n  (\n    archiveRequest: ClientRequest<\n      string,\n      StorageEvent | StorageDone | StorageErrorEvent\n    >,\n  ): Archive[\"storageSubscription\"] =>\n  (hash, inputs, childTrie, onItem, onError, onDone) => {\n    if (inputs.length === 0) {\n      onDone()\n      return noop\n    }\n\n    let isRunning = true\n    let cancel = () => {\n      isRunning = false\n    }\n\n    archiveRequest(\"storage\", [hash, inputs, childTrie], {\n      onSuccess: (operationId, followSubscription) => {\n        const stopOperation = () => {\n          archiveRequest(\"stopStorage\", [operationId])\n        }\n\n        if (!isRunning) return stopOperation()\n\n        const doneListening = followSubscription(operationId, {\n          next: (event) => {\n            const { event: type } = event\n            if (type === \"storage\") {\n              const { event: _, ...item } = event\n              onItem(item)\n            } else if (type === \"storageDone\") _onDone()\n            else _onError(new StorageError(event.error))\n          },\n          error: onError,\n        })\n\n        const tearDown = () => {\n          cancel = noop\n          doneListening()\n        }\n\n        cancel = () => {\n          tearDown()\n          stopOperation()\n        }\n\n        const _onError = (e: Error) => {\n          tearDown()\n          onError(e)\n        }\n\n        const _onDone = () => {\n          tearDown()\n          onDone()\n        }\n      },\n      onError,\n    })\n\n    return () => {\n      cancel()\n    }\n  }\n"],"names":[],"mappings":";;;AAmBa,MAAA,eAAA,GACX,CACE,cAKF,KAAA,CAAC,MAAM,MAAQ,EAAA,SAAA,EAAW,MAAQ,EAAA,OAAA,EAAS,MAAW,KAAA;AACpD,EAAI,IAAA,MAAA,CAAO,WAAW,CAAG,EAAA;AACvB,IAAO,MAAA,EAAA;AACP,IAAO,OAAA,IAAA;AAAA;AAGT,EAAA,IAAI,SAAY,GAAA,IAAA;AAChB,EAAA,IAAI,SAAS,MAAM;AACjB,IAAY,SAAA,GAAA,KAAA;AAAA,GACd;AAEA,EAAA,cAAA,CAAe,SAAW,EAAA,CAAC,IAAM,EAAA,MAAA,EAAQ,SAAS,CAAG,EAAA;AAAA,IACnD,SAAA,EAAW,CAAC,WAAA,EAAa,kBAAuB,KAAA;AAC9C,MAAA,MAAM,gBAAgB,MAAM;AAC1B,QAAe,cAAA,CAAA,aAAA,EAAe,CAAC,WAAW,CAAC,CAAA;AAAA,OAC7C;AAEA,MAAI,IAAA,CAAC,SAAW,EAAA,OAAO,aAAc,EAAA;AAErC,MAAM,MAAA,aAAA,GAAgB,mBAAmB,WAAa,EAAA;AAAA,QACpD,IAAA,EAAM,CAAC,KAAU,KAAA;AACf,UAAM,MAAA,EAAE,KAAO,EAAA,IAAA,EAAS,GAAA,KAAA;AACxB,UAAA,IAAI,SAAS,SAAW,EAAA;AACtB,YAAA,MAAM,EAAE,KAAA,EAAO,CAAG,EAAA,GAAG,MAAS,GAAA,KAAA;AAC9B,YAAA,MAAA,CAAO,IAAI,CAAA;AAAA,WACb,MAAA,IAAW,IAAS,KAAA,aAAA,EAAuB,OAAA,EAAA;AAAA,eAC7B,QAAA,CAAA,IAAI,YAAa,CAAA,KAAA,CAAM,KAAK,CAAC,CAAA;AAAA,SAC7C;AAAA,QACA,KAAO,EAAA;AAAA,OACR,CAAA;AAED,MAAA,MAAM,WAAW,MAAM;AACrB,QAAS,MAAA,GAAA,IAAA;AACT,QAAc,aAAA,EAAA;AAAA,OAChB;AAEA,MAAA,MAAA,GAAS,MAAM;AACb,QAAS,QAAA,EAAA;AACT,QAAc,aAAA,EAAA;AAAA,OAChB;AAEA,MAAM,MAAA,QAAA,GAAW,CAAC,CAAa,KAAA;AAC7B,QAAS,QAAA,EAAA;AACT,QAAA,OAAA,CAAQ,CAAC,CAAA;AAAA,OACX;AAEA,MAAA,MAAM,UAAU,MAAM;AACpB,QAAS,QAAA,EAAA;AACT,QAAO,MAAA,EAAA;AAAA,OACT;AAAA,KACF;AAAA,IACA;AAAA,GACD,CAAA;AAED,EAAA,OAAO,MAAM;AACX,IAAO,MAAA,EAAA;AAAA,GACT;AACF;;;;"}