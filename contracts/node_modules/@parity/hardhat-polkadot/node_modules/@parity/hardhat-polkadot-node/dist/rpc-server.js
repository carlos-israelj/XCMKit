"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createRpcServer = createRpcServer;
const dockerode_1 = __importDefault(require("dockerode"));
const errors_1 = require("./errors");
const eth_rpc_1 = require("./services/eth-rpc");
const substrate_node_1 = require("./services/substrate-node");
const chopsticks_1 = require("./services/chopsticks");
const utils_1 = require("./utils");
function createRpcServer(opts) {
    let substrateNodeService;
    let ethRpcService;
    let chopsticksService;
    return {
        listen(nodeArgs = [], adapterArgs = [], blockProcess = true) {
            substrateNodeService = new substrate_node_1.SubstrateNodeService(nodeArgs, blockProcess);
            ethRpcService = new eth_rpc_1.EthRpcService(adapterArgs, blockProcess);
            chopsticksService = new chopsticks_1.ChopsticksService(nodeArgs, blockProcess);
            if (!!opts.adapterPath && !!opts.nodePath && !opts.isForking) {
                return Promise.all([
                    substrateNodeService.from_binary(opts.nodePath),
                    ethRpcService.from_binary(opts.adapterPath),
                ]).then(() => { });
            }
            if (opts.docker && !opts.isForking) {
                const docker = new dockerode_1.default({ socketPath: (0, utils_1.getDockerSocketPath)(opts.docker) });
                return Promise.all([
                    substrateNodeService.from_docker(docker),
                    ethRpcService.from_docker(docker, substrateNodeService.port),
                ]).then(() => { });
            }
            if (!!opts.adapterPath && opts.isForking) {
                return Promise.all([
                    chopsticksService.from_binary(""),
                    ethRpcService.from_binary(opts.adapterPath),
                ]).then(() => { });
            }
            if (opts.docker && opts.isForking) {
                const docker = new dockerode_1.default({ socketPath: (0, utils_1.getDockerSocketPath)(opts.docker) });
                chopsticksService.from_binary("");
                return ethRpcService.from_docker(docker, chopsticksService.port);
            }
            throw new errors_1.PolkadotNodePluginError("Wrong hardhat network configuration. Please see https://github.com/paritytech/hardhat-polkadot/tree/main/examples");
        },
        stop() {
            return Promise.all([
                substrateNodeService.stop(),
                ethRpcService.stop(),
                chopsticksService.stop(),
            ]).then(() => undefined);
        },
    };
}
//# sourceMappingURL=rpc-server.js.map